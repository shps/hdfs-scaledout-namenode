#
# Generated by Chef
#
# omq - GlassFish OpenMQ server
#
description     "GlassFish <%= @resource.instance %> OpenMQ server"

start on filesystem or runlevel [2345]
stop on runlevel [!2345]

# Increase default timeout before killing (on stop) to 10 seconds
kill timeout 10

<% omq_home = "#{node['glassfish']['base_dir']}/mq" %>
<% authbind_prefix = @authbind ? "/usr/bin/authbind --deep " : "" %>

pre-start script
    test -x <%= omq_home %>/bin/imqbrokerd || { stop; exit 0; }
end script

exec su <%= node['glassfish']['user'] %> -c '<%= authbind_prefix %><%= omq_home %>/bin/imqbrokerd -vmargs "<%= @vmargs %>" -varhome <%= node['openmq']['var_home'] %> -javahome <%= node["java"]["java_home"] %> -name "<%= @resource.instance %>"'

# Uglies to wait until the broker is actually up before completion of the 'start'
post-start script
  <% @listen_ports.sort.each do |listen_port| %>
  while [ $(netstat -nl | grep -c '0.0.0.0:<%= listen_port %> ') -eq 0 ]
  do
    sleep 1
  done
  <% end %>
end script

# Uglies to wait until the broker is actually up before completion of the 'stop'
post-stop script
  <% @listen_ports.sort.each do |listen_port| %>
  while [ $(netstat -nl | grep -c '0.0.0.0:<%= listen_port %> ') -ne 0 ]
  do
    sleep 1
  done
  <% end %>
end script
