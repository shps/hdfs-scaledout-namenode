#!/bin/sh

BACKUP_DIR="<%= @ndb_dir %>/backup"
BACKUP_ID=1
NDB_DATA_DIR="<%= @ndb_dir %>/ndb_data"

  case $1 in
    "-h"|"--help"|"-help")
         echo ""
         echo "Usage: prog_name [-b ID \(default=1\)] [-d BACKUP-DIR \(default=<%= @ndb_dir %>/backup\)]"
         echo ""
         echo "Copies backups, with optionally supplied backup id from data-nodes to mgm server."
         echo "You need to authenticate at all data nodes to copy their backup files."
         echo ""
         exit 0
         ;;      
    "-d")
         shift
         BACKUP_DIR=
         ;;
    "-b")
         shift
         BACKUP_ID=
         ;;
  esac 

  BACKUP_FILE="BACKUP-$BACKUP_ID.tgz"
  BACKUP_FILES=

  HOST[0]="cloud8" ;   HOST[1]="cloud9"
  HOST[2]="cloud12" ;   HOST[3]="cloud13"
  HOST[4]="localhost" ;   HOST[5]="localhost"
  HOST[6]="localhost" ;   HOST[7]="localhost"
  HOST[8]="localhost" ;   HOST[9]="localhost"
  NUM=0

  while [ $NUM -lt 4 ] ; do

    node="${HOST[$NUM]}"
    # directory numbers start from '1'
    NUM=`expr $NUM + 1`

    echo ""
    echo "Creating a .tgz archive of backup-id $BACKUP_ID at node-id $NUM:"
    
    # tar/zip up backup at ndbd
    TAR_ZIP="cd $NDB_DATA_DIR && tar zcf $NUM-$BACKUP_ID.tgz $NUM\/BACKUP"
    
    ssh root@${node} ${TAR_ZIP}

    if [ $? -ne 0 ] ; then
      echo ""
      echo "Failure: Could not find directory or run tar successfully at ${node}. Failure Code: $?"
      echo ""
      exit $?
    fi

    # copy archive to backup dir
     echo "Scp'ing the archived backup-id $BACKUP_ID from node-id $NUM to the mgm server:"
     
     if [ ! -d $BACKUP_DIR ] ; then
       mkdir $BACKUP_DIR
       if [ $? -ne 0 ] ; then
          echo ""
          echo "Failure: Could not create backup dir: $BACKUP_DIR. Failure Code: $?"
          echo ""
          exit $?
       fi
     fi

     scp root@${node}:${NDB_DATA_DIR}\/$NUM-$BACKUP_ID.tgz ${BACKUP_DIR}

     if [ $? -ne 0 ] ; then
       echo ""
       echo "Failure: could not scp backup archive from ${node}. Failure Code: $?"
       echo ""
       exit $?
     fi

     BACKUP_FILES="$BACKUP_FILES $NUM-$BACKUP_ID.tgz"
  done

  cd $BACKUP_DIR
  tar zcf $BACKUP_FILE $BACKUP_FILES

  if [ $? -ne 0 ] ; then
      echo ""
      echo "Failure: Could not created single backup archive. Failure Code: $?"
      echo ""
      exit $?
  fi

  for f in $BACKUP_FILES ; do
    rm $f
  done

   echo ""
   echo ""
   echo "The backup is now stored in:"
   echo " $BACKUP_DIR/$BACKUP_FILE"
   echo ""
   echo ""
   exit 0

