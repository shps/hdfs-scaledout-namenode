#!/bin/sh 

SKIP_NDBDS=0
SKIP_MYSQLDS=0
SKIP_USER_CHECK=0

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help|-help)
              echo "usage: <prog> [--skip-ndbds (do not start data nodes)] [--skip-mysqlds (do not start mysql servers)] [-sc (delete old configurations)] [-f skip user check]"
	      echo ""
	      echo "connectstring is set to cloud11:1186"
	      exit 0 
	      ;;
    -f|--force)
              SKIP_USER_CHECK=1
	      ;;
    -sc)
              echo "Deleting old configurations from /<%= @ndb_dir %>/mgmd1/"
              rm -rf ../<%= @ndb_dir %>/mgmd1/*
	      ;;
    --skip-ndbds)
              SKIP_NDBDS=1
	      ;;
    --skip-mysqlds)
              SKIP_MYSQLDS=1
	      ;;
	   * )
              echo "Unknown option '$1'" 
              exit -1
  esac
  shift       
done


  echo "" 
  echo "Testing to see if a cluster is already running on host 'cloud11:1186' ..." 
  echo "" 
  <%= @mysql_dir %>/bin/ndb_mgm -c cloud11:1186 -t 2 -e show 1> /dev/null

  if [ $? -eq 0 ] ; then
      echo ""      
      echo "A management server is already running on cloud11:1186" 
      echo "" 	
      exit 2
  fi



USERID=`id | sed -e 's/).*//; s/^.*(//;'`
if [ "X$USERID" != "Xroot" ]; then
 if [ "X$USERID" = "Xroot" ]; then
   echo ""
   echo "You started cluster as user: 'root'."
   echo "You should start cluster as user: 'root'."
   echo "If you continue, you will change ownership of database files"
   echo "from 'root' to 'root'."
# TODO: return -2
 else
   echo ""
   echo "You started the cluster as user: '$USERID'."
   echo "You should start the cluster as user: 'root'."
   echo "If you continue, you will change ownership of database files"
   echo "from 'root' to '$USERID'."
# TODO: return -2
 fi
 
 echo ""
start_as_wrong_user() 
{
  echo -n "Do you really want to start the cluster as user 'root'? y/n/h(help) "
  read ACCEPT
  case $ACCEPT in
   y | Y)
      ;;
   n | N)
      echo ""
      echo "Bye.."
      echo ""
      exit 1
      ;;
    *)
      echo ""
      echo -n "Please enter 'y' or 'n'." 
      start_as_wrong_user
      ;;
   esac
}
start_as_wrong_user


fi  



echo "Cluster Startup may take a few minutes."  


echo "Truncating the cluster log file: <%= @ndb_dir %>/logs/cluster.log"
rm <%= @ndb_dir %>/logs/cluster.log 

echo "Starting the Management Server ....."

if [ -e <%= @ndb_dir %>/logs/cluster.log ] ; then
    SIZE_CL=`cat <%= @ndb_dir %>/logs/cluster.log | wc -l`
else
    SIZE_CL=0
fi

#remove memory of old configurations
#echo If you want to remove warnings for incompatible configuration changes, run rm -rf ../$NDB_DIR/$MGM_DATADIR/*

<%= @mysql_dir %>/bin/ndb_mgmd -f <%= @ndb_dir %>/config.ini  --configdir=<%= @ndb_dir %>/mgmd1 --reload   

if [ $? -ne 0 ] ; then
  echo "Problem starting the Management Server."
  echo "Please read the logs in:"
  echo "<%= @ndb_dir %>/logs."
  echo "<%= @ndb_dir %>/mgmd_1"
  exit 1
fi

MGMD_STARTED=0

echo "Waiting for ndb_mgmd to start"
    

MGMD_TIMEOUT=200
MGMD_COUNT=0
while [ $MGMD_STARTED -eq 0 ] ; do

  if [ -e <%= @ndb_dir %>/logs/cluster.log ] ; then
    UPDATED_SIZE_CL=`cat <%= @ndb_dir %>/logs/cluster.log | wc -l`
  else
    UPDATED_SIZE_CL=0
  fi
    
  if [ $SIZE_CL -lt $UPDATED_SIZE_CL ] ; then
	MGMD_STARTED=1;
	echo ""
  else

      if [ ${MGMD_COUNT} -eq 0 ] ; then
	  echo -n "Seconds left before timeout: "
      fi

      echo -n "`expr ${MGMD_TIMEOUT} - ${MGMD_COUNT}` "
      sleep 1
      MGMD_COUNT=`expr ${MGMD_COUNT} + 1`

      if [ $MGMD_COUNT -gt $MGMD_TIMEOUT ] ; then
	  MGMD_STARTED=2;
      fi
  fi

done

  if [ $MGMD_STARTED -ne 1 ] ; then
   echo ""
   echo "Failure when starting the 'ndb_mgmd'."
   echo "Please check for errors in your configuration file or report a bug."
   echo ""
   echo "You now need to kill the ndb_mgmd process."
   echo "To find the proceses-id of ndb_mgmd: 'ps -ef | grep ndb_mgmd | grep root' "
   echo "To kill the process: kill -9 [process-id]"
   exit 2
  fi


sleep 1




echo "Starting a Data Node on host: cloud8   "

ssh root@cloud8 /var/lib/mysql-cluster/ndb/scripts/start-noinit-ndbd-1.sh

if [ $? -ne 0 ] ; then
  echo "Problem starting a Data Node on host cloud8."
  echo "Please read the logs on host cloud8 in directories:"
  echo "<%= @ndb_dir %>/logs"
  echo "<%= @ndb_dir %>/data_dir/1"
fi
sleep 1


echo "Starting a Data Node on host: cloud9   "

ssh root@cloud9 /var/lib/mysql-cluster/ndb/scripts/start-noinit-ndbd-2.sh

if [ $? -ne 0 ] ; then
  echo "Problem starting a Data Node on host cloud9."
  echo "Please read the logs on host cloud9 in directories:"
  echo "<%= @ndb_dir %>/logs"
  echo "<%= @ndb_dir %>/data_dir/2"
fi
sleep 1


echo "Starting a Data Node on host: cloud12   "

ssh root@cloud12 /var/lib/mysql-cluster/ndb/scripts/start-noinit-ndbd-3.sh

if [ $? -ne 0 ] ; then
  echo "Problem starting a Data Node on host cloud12."
  echo "Please read the logs on host cloud12 in directories:"
  echo "<%= @ndb_dir %>/logs"
  echo "<%= @ndb_dir %>/data_dir/3"
fi
sleep 1


echo "Starting a Data Node on host: cloud14   "

#ssh root@cloud14 /var/lib/mysql-cluster/ndb/scripts/start-noinit-ndbd-4.sh

if [ $? -ne 0 ] ; then
  echo "Problem starting a Data Node on host cloud13."
  echo "Please read the logs on host cloud13 in directories:"
  echo "<%= @ndb_dir %>/logs"
  echo "<%= @ndb_dir %>/data_dir/4"
fi
sleep 1

echo "Waiting for the cluster to be ready by calling:"
echo "ndb_waiter -c cloud11:1186 --timeout=300"
echo "This can take a few minutes..."

<%= @mysql_dir %>/bin/ndb_waiter -c cloud11:1186 --timeout=300 2>&1 > /dev/null

if [ $? -ne 0 ] ; then
    echo "Error when waiting on the cluster to be ready."
    echo "Exiting..."
    exit 3
fi

<%= @ndb_dir %>/scripts/start-mysqlds.sh $SKIP_MYSQLDS

sleep 1

<%= @ndb_dir %>/scripts/mgm-client.sh -e show

exit 0

